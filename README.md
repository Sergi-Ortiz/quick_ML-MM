# __quick-MLMM__
This repository contains scripts to quickly:

1. **Extract precatalytic frames** from any given MD trajectory. 

2. **Set up ML/MM calculations** via [ML/MM-toolkit]() to quickly locate a plausible TS. This gpu-accelerated implementation is restricted to using UMA models. 

3. **Set up QM/MM calculations** via ChemShell given its corresponding scripts. 

4. **Validate and compare ML/MM calculations** comparing their result on the respective QM/MM result.  (TODO) 

## __Workflow__


The objective of this repo is to provide the scripts necessary to quickly set up QM/MM and ML/MM calculations from a MD trajectory. The only MD format supported is AMBER.

First, the trajectory is analyzed and precatalytic frames are extracted given a structural condition (`extract_precatalytic.py`). Each frame is then trimmed and parametrized for QM/MM and ML/MM calculations (`prepare_frames.py`). From there, QM/MM or ML/MM jobs are built for each extracted frame from a set of commont templates (`setup_qmmm.py` and `setup_mlmm.py`, respectively). 

This routine only requires the complex structure, `frame.pdb`, its coordinates, `frame.inpcrd` and its topology `frame.prmtop` (additionally, the  QM region `.act_list` for QM/MM and  ML region `ml_region.pdb` for ML/MM). The objective is to prepare the simulations quickly and in a reproductible manner. 

```
base_dir (where QM/MM or ML/MM calculations are to be prepared)
├── md_traj
│   ├── frame.pdb
│   ├── frame.inpcrd
│   ├── frame.prmtop
│   └── prod/out/<MD traj files>.nc 
├── preprocessing (autogenerated by `extract_precatalytic.py`)
│   ├── frame_extraction
│   ├── frame_parametrization
│   └── preprocessing scripts
├── scripts
│   ├── extract_precatalytic.py
│   ├── preprocessing_scripts
│   ├── qmmm_scripts
│   └── mlmm_scripts
├── QM-MM (autogenerated by `prepare_frames.py`)
│   ├── qmmm_scripts
│   │   └── <job specific scripts>
│   └── <frame>
│       ├── src
│       │   └── .inpcrd / .prmtop / .pdb / .act_list
│       └── <job>
└── ML-MM (autogenerated by `prepare_frames.py`)
    ├── mlmmm_scripts
    │   └── <job specific scripts reused for each frame>
    └── <frame>
        ├── src
        │   └── .inpcrd / .prmtop / .pdb
        ├── coord (generated in the ML/MM workflow)
        └── <job>.yaml
```






## __Script description__
General scripts
- `extract_precatalytic.py`. Contains the structural conditions to define precatalytic frames and extracts them. **System dependent.**
    - Example command to extract 1 precatalytic structures from a MD run with ALOX15/5-HETE @ H10 with precatalytic definition of 4Å distance and dihedral angle of 10 degrees `python extract_precatalytic.py -m 5-HETE -H 10 -d 4.0 -l 20.0 -n 1 -e 1`. The `-e 1` flag asks to extract frame `1` necessarily. 

Preprocessing scripts (in `preprocessing_scripts`)
- `prepare_frames.py`. Trims all extracted frames (mainly the solvent) and parametrizes the new system with `tleap` (reparametrization step). Trimmed newly parametrized frames are stored in `frame_parametrization`. Finally, it extracts relevant files for both QM/MM and ML/MM calculations, storing them in `QM-MM` and `ML-MM` directories with their respective QM/MM or ML/MM scripts.
    - Example command `python prepare_frames.py -H 10 -m 5-HETE` will preprocess all previously extracted frames for an abstraction of H10 of ALOX15/5-HETE.

QM/MM scripts (in `qmmm_scripts`)
- `setup_qmmm.py`. Sets up OPT, SCAN and TS jobs for all frames in `QM-MM` directory. This was automated as part of the final BSc thesis in Chemistry. 
- `QM/MM-specific scripts`. These are all the files required for setting up proper OPT, SCAN and TS jobs with ChemShell. Created during the final BSc thesis in Chemistry.

ML&MM scripts (in `mlmm_scripts`)
- `setup_mlmm.py`. Sets up the ML/MM region and the specific OPT, SCAN and TS jobs via [ML/MM-toolkit](). 

- `ML/MM-scpecific sripts`. These files are the templates needed to build the optimizations, scans, GSM calculations and TS searches. 

## __Dependencies__
- **Frame extraction and preprocessing.** Requires a machine with AMBER CLI tools installed and a conda venv with EMDA version `easymda==1.0.0a5` to perform the precatalytic structure analysis and its extraction. 

- **QM/MM job setup.** No special requirements. 

- **ML/MM job setup.** Requires a conda venv with `mlmm-toolkit` (latest version), `cuda/pytorch` installed correctly, and `FAIRChem` (UMA model) installed and set up. 


### __TODO__
> **directed_QM/MM.** The implementation of ML/MM in the traditional QM/MM workflow might be benefitial in a key way: the possibility of directing expensive QM/MM calculation to "catalytically reasonable/representative" frames by performing simulations in 100 (precatalytic) frames and then downsampling to the "best 10 frames" (lower $\Delta E^\ddag$) from which the TS can be located with QM/MM precision. 

- Application of UMA models is particularly benefitial for LOX systems as it mimics the befaviour or high-end DFT calculations with metals, while being much more precise than semiempirical (might be problematic for transition metal-containing systems, where SQM often fails. )
- Add analysis capabilities to ML/MM results (TS and GSM scan). 
- Subsample best x ML/MM TS structures 